% cap3.tex

\chapter{Desarrollo Metodológico} \label{MCP:subastador} % la etiqueta para referencias


\section{Replicación del Modelo original y resolución por medio de MCP}

Una de las formas de resolver el problema original de \citeB{amigo_two_2021}, gracias a su forma, es transformarlo en un MCP. Esto es posible gracias al teorema de Karush-Kuhn-Tucker \ref{descripcionkkt} y sus condiciones resultantes. 
\vspace{2.5mm}

Por lo tanto, para replicar el modelo original, se realiza esta transformación y luego es probada en un \textit{solver} para evaluar y comparar sus resultados con el original.

\subsection{MCP problema del subastador} \label{MCPsubastador}

En adición a lo realizado con el problema del productor y las restricciones condiciones de mercado que relacionan a los productores con el subastador, se debe transformar el problema de este último \ref{eq:sub} en un MCP. Al igual que el caso anterior, para convertir el problema en un MCP, una de las opciones es aplicar el teorema de KKT. Para comenzar, se obtiene el siguiente lagrangeano:

\footnotesize{
\begin{align}
\mathcal{L}(\theta) = -\theta\pi^a + \mathcal{F}(\theta) - \eta (\varphi^-1(M)\sigma+\mu-\theta) - \varrho(\theta)  \label{eq:lagrange2}
\end{align}}

\subsubsection{Derivada parcial respecto a $\theta$}

Debido a que $\theta$ es la única variable del modelo, solo se debe realizar la derivada del lagrangeano respecto a esta. Obteniendo lo siguiente:

\footnotesize{
\begin{align}
    \frac{\partial \mathcal{L}(\theta) }{\partial \theta} = 0 =  -\pi^a + \frac{\partial\mathcal{F}(\theta)}{\partial \theta} + \eta - \varrho \\
    \Leftrightarrow -\pi^a + \frac{\partial\mathcal{F}(\theta)}{\partial \theta} + \eta = \varrho \label{kkt:subastadororiginal}
\end{align}
}
Donde $\varrho$ es la variable dual de la naturaleza de $\theta$ (\ref{res:sub2}). Obteniendo la siguiente complementariedad:

\footnotesize{
\begin{align}
    \theta \geq 0 \\
    -\pi^a + \frac{\partial\mathcal{F}(\theta)}{\partial \theta} + \eta \geq 0\\
    \theta \cdot (-\pi^a + \frac{\partial\mathcal{F}(\theta)}{\partial \theta} + \eta)=0
\end{align}
}
En el código GAMS de la programación del modelo, se encuentra la kkt \ref{kkt:subastadororig} en la línea 716:

\begin{verbatim}
    kkt_auctioneer..                         -pi_a + eta  =g=0
\end{verbatim}

Realizando la complementariedad en la línea 756:

\begin{verbatim}
    kkt_auctioneer.theta
\end{verbatim}

Para finalizar el MCP del subastador es necesario considerar la complementariedad de la restricción \ref{res:sub2}, obteniendo lo siguiente: 

\footnotesize{
\begin{align}
 \eta \geq 0 \\
 \varphi^-1(M)\sigma+\mu-\theta \geq 0 \\
 \eta \cdot (\varphi^-1(M)\sigma+\mu-\theta)=0
\end{align}}

Esta restricción y complementariedad se encuentran en las líneas 717 y 757 respectivamente:

\begin{verbatim}
    theta_const..   -theta + PhiRisk*(Std)+mean =g= 0;
    theta_const.eta
\end{verbatim}

\subsection{Resolución del problema y resultados}

Finalmente, para resolver el problema en GAMS, solo se debe completar la información adicional, como parámetros, definición de variables y aplicar las líneas de código necesarias para un MCP en GAMS. Con esto realizado, se obtuvieron los siguientes resultados:
\vspace{2.5mm}

CREAR UNA TABLA CON LOS RESULTADOS DEL GAMS, INCLUIR DISTINTOS CAP, THETA, LOS PRECIOS, PRODUCCIONES. 
TAL VEZ COMPARAR CON LOS RESULTADOS CON JULIA.

\section{Problema del subastador}

Este problema de optimización (el del subastador) considera como única variable la cantidad de permisos de contaminación $\theta$ los cuales están en unidades $tCO_2 e$ (toneladas de dióxido de carbono emitidas). Estos son los permisos comprados por las empresas generadoras en la primera etapa del modelo. Amigo define que el presupuesto de carbono denotado $CAP$, el cual establece el nivel de emisiones en la segunda etapa, sigue una distribución normal de varianza cero, donde $\theta$ no puede sobrepasar probabilística mente el el presupuesto de emisión, como se denota en \ref{res:subastador0} donde $\varepsilon$ representa el margen de permisos de emisión total. \ref{res:sub1} nace de esta condición donde $\varphi^-1$ es la inversa de la acumulada de la distribución normal de CAP. Es acá donde surge la posibilidad de investigación para este trabajo. 
\vspace{2.5mm}

\begin{equation}
\begin{array}{cl}
    Pr(\theta \geq CAP)\leq \varepsilon \label{res:subastador0}
\end{array}
\end{equation}
\vspace{2.5mm}

\citeB{amigo_two_2021} comentan que existe espacio para desarrollar y perfeccionar el problema del subastador. Por un lado el problema del productor está desarrollado de forma extensa con muchas restricciones que la definen, pero el subastador tiene un papel tan importante como el de los productores ya que este será el que tome las decisiones iniciales con las cuales la generación de energía se verá influenciado por mucho tiempo. Las decisiones del subastador deben ser consideradas tan especificas y desarrolladas que las de los generadores de electricidad. Es por esto que surge la oportunidad de encontrar una forma más completa de representar a este agente, formular las restricciones y cambios en la función objetivo si es necesario y luego evaluar la reformulación del modelo en un \textit{solver}.

Uno de los problemas del modelo original del subastador \ref{eq:sub} es que para simplificar su cálculo en el \textit{solver} y KKT, la distribución normal asociada al $CAP$ presentaba desviación estándar $\sigma$ igual a cero y el único valor representativo del presupuesto era la media $\mu$, dejando de ser realmente una entrada estocástica. 
\vspace{2.5mm}

También, el subastador es representado como un planificador que minimiza el negativo de la utilidad, siendo $-\theta \pi^a$ el ingreso negativo por ventas de los permisos y $F(\theta)$ una función de costo asociado a la producción de energía por carbón. El problema en esto es que parece no explicar con totalidad la importancia del subastador en el problema. Ya que este debe ser un ente que busca maximizar sus beneficios tal cual  lo son las empresas generadoras de electricidad en el sistema pero debe tener restricciones que lo incentiven a emitir la cantidad de permisos correctos, o sea, la cantidad de permisos más cercana al presupuesto de carbono $CAP$ estocástico del sistema.
\vspace{2.5mm}

Entonces, esta es un área de exploración para determinar cuál sería una reformulación del problema del subastador donde exista un incentivo por emitir los permisos adecuados y así los generadores no tengan que pagar precios más elevados de los que deberían ser.
\vspace{2.5mm}

Una forma propuesta es la de incluir la probabilidad de encontrar un $\theta$ adecuado, el cual afecte el ingreso del subastador (la ganancia no se calcula como $p\cdot q$ sino que como $p\cdot q\cdot P$, donde $P$ es una proporción entre $[0,1]$ que representa la precisión). Esta probabilidad esté determinada por la cantidad invertida en acercarse al presupuesto lo más posible, medido como gasto en información. Esto no remplaza al costo social del carbón (SCC por sus siglas en inglés), es un costo adicional.


\section{Racionalidad del Planificador}

El planificador debe elegir el número de permisos $\theta$ a vender en el mercado en $t=0$ a precio $\pi^a$. Para esto es lógico pensar que la elección del número de permisos se debe basar en el beneficio que genera la venta de los permisos. Los ingresos serán dados por $\pi^a\cdot\theta$. Los costos vendrán dados por una función $\mathcal{F}(\theta)$ que representa, usualmente, el Costo Social del Carbon. Adicionalmente, el subastador dispone de un presupuesto de emisiones de $CO_2$ es $CAP\in\mathbb{R}_+$ que es una variable aleatoria. De esta forma el planificador debiera maximizar sus beneficios, $\pi^a\cdot\theta-\mathcal{F}(\theta)$, restringido a vender una cantidad de permisos inferior al presupuesto, $\theta\leq CAP$.
\vspace{2.5mm}

Sin embargo, $CAP$ es una variable aleatoria difícil de estimar. De esta forma, \citeB{amigo_two_2021} se limitan a incluir una restricción probabilística que limita la sobre-emisión de permisos por una probabilidad $\epsilon$ pequeña:

$$Pr(\theta\geq CAP)\leq\epsilon.$$

De esta forma, dada la estructura estocástica de $CAP$ (por ejemplo, distribuida según una normal con media $\mu$ y varianza $\sigma^2$), el problema del planificador se resume por las ecuaciones (9) y (10) de Amigo et alii.
\vspace{2.5mm}

En este trabajo el objetivo principal del planificador social es el grado de precisión con el que se cumple la restricción presupuestaria $\theta\leq CAP$. De esta forma maximizará

$$r\cdot Pr(\theta\leq CAP)-\tilde{\mathcal{F}}(Pr(\theta\leq CAP)),$$ \label{nuevafposible}

Donde $r$ es la valor de cumplir exactamente con el presupuesto, en este caso es el ingreso total de venta de los permisos ($r = \theta \pi^a$) y $\tilde{\mathcal{F}}$ es una función de costo por desempeño de cumplimiento que puede tomar una forma cuadrática:

\begin{equation}
\begin{array}{rrclcl}
    \tilde{\mathcal{F}}(P)=\begin{cases}0,&P\leq d\\c(P-d)^2,&P>d\end{cases}\label{costoperformace}\\
\end{array}
\end{equation}

Donde $d$ es el umbral de desempeño con información pública y $c$ es el costo marginal de adquirir información para mejorar el desempeño en cumplimiento.
\vspace{2.5mm}

Finalmente, se define el \emph{performance} óptimo para el premio ($r = \theta \pi^a$). Donde el \emph{performace} óptimo  se define como $P^*(r) = (C')^{-1}(r)$ de la siguiente forma:

\begin{equation}
\begin{array}{rrclcl}
    P^*(\theta \pi^a) = \begin{cases}\frac{\theta \pi^a}{2c}+d,&\theta \pi^a\leq 2c(1-d)\\1,&\theta \pi^a>2c(1-d)\end{cases}, \label{performaceoptimo}\\
\end{array}
\end{equation}

\section{Reordenando modelo del subastador con función de costo diferenciable}

\citeB{dewan_estimating_2020} propone la opción de agregar una función de costo asociada al \textit{performance}(rendimiento en inglés) de obtener la variable de decisión (en este caso $*\theta*$) lo más cercana a la óptima al invertir en investigación que mejore la estimación de la variable.
\vspace{2.5mm}

Considerando \ref{nuevafposible}, tomando $Pr(\theta\leq CAP) = P$ con $P = $\textit{performance}, la función objetivo del subastador puede reorganizarse de la siguiente forma:

\begin{equation}
\begin{array}{rrclcl}
    \displaystyle \min_{\theta,P} & -\theta \pi^aP + \tilde{\mathcal{F}}(P)+F(\theta)  \label{fo:performance0}\\
\end{array}
\end{equation}

Para completar el problema de optimización se debe definir ciertos supuesto. Para comenzar, se debe definir que factores serán variables y parámetros. Por el momento, se asume que la única variable es $\theta$ y el subastador busca un \textit{performace} mayor al umbral de información pública.  
\vspace{2.5mm}

Entonces, debe identificarse $\tilde{\mathcal{F}}(P)$ de acuerdo a su definición en \ref{costoperformace} cuando se cumple que el \textit{performace} es mayor al umbral de información pública $d$ entonces se define lo siguiente, conociendo los parámetros $c, d$:

$$\tilde{\mathcal{F}}(P)=c(P-d)^2$$ 

De esto se deben definir las restricciones del problema. La primera corresponde a la positividad de $\theta$. 

\begin{equation}
\begin{array}{cl}
    \theta \geq 0 & (\varrho)\label{res:newsub1}
\end{array}
\end{equation}

Para la segunda, se debe aplicar la función de \textit{performance} óptimo para el ingreso \ref{performaceoptimo}. La idea es encontrar una restricción para definir este problema teniendo solo a $\theta$ como variable. Entonces la opción es aplicar la siguiente restricción: 

\begin{equation}
\begin{array}{cl}
    \theta \pi^a\leq 2c(1-d) & (\eta) \label{res:newsub2}
\end{array}
\end{equation}

Con esto el problema del subastador quedaría reformulado de la siguiente manera:

\begin{equation}
\begin{array}{rrclcl}
    \displaystyle \max_{\theta} & \theta \pi^a(\frac{\theta \pi^a}{2c}+d) - c((\frac{\theta \pi^a}{2c}+d)-d)^2  \\\textrm{s.a.}\\
\end{array}
\end{equation}
\begin{equation}
\begin{array}{cl}
    \theta \pi^a\leq 2c(1-d) & (\eta) \label{res:newsub2}
\end{array}
\end{equation}
\begin{equation}
\begin{array}{cl}
    \theta \geq 0 & (\varrho)\label{res:newsub1}
\end{array}
\end{equation}

\subsubsection{Maximizando el rendimiento}

Esta formulación es considerada completa en un contexto donde, al igual que el trabajo original, se quiere maximizar los \textit{allowances} (permisos de contaminación) para la industria generadora. Pero, en esta memoria, se busca reordenar el problema donde el subastador sufra perdidas por su mala gestión, intentando mejorar su rendimiento.
\vspace{2.5mm}

Para lograr lo anterior, es necesario definir el problema tomando como variable de decisión el rendimiento ( \textit{performance}). Con esto, es necesario definir la variable $P$ respecto a $\theta$ para que poder utilizar el problema en el modelo general al incluir a el problema de los productores(generadores de electricidad).
\vspace{2.5mm}

Luego, de \ref{res:newsub2} y \ref{performaceoptimo} se obtiene la siguiente igualdad:

$$P^*(\theta \pi^a) = \frac{\theta \pi^a}{2c}+d$$

Si se despeja $P$ se obtiene su valor respecto a $\theta$:

$$\theta=\frac{(P-d)2c}{\pi^a}$$

Despejando esta variable en \ref{fo:performance0}, se obtiene la siguiente función objetivo:


\begin{equation}
\begin{array}{rrclcl}
    \displaystyle \max_{P} & \frac{(P-d)2c}{\pi^a} \pi^{a}P - c(P-d)^2  \label{fo:3}\\
\end{array}
\end{equation}

La cuál se puede simplificar llegando a lo siguiente:

\begin{equation}
\begin{array}{rrclcl}
    \displaystyle \max_{P} & c(P^{2}-d^{2}) \label{fo:4}\\
\end{array}
\end{equation}

La cuál tiene sentido pero no es aplicable en el trabajo \citeB{dewan_estimating_2020}, ya que según la proposición 4, descrita en \ref{marco:costos}, el problema de maximización debe ser cóncavo. Pero debido a la forma en la que se definió el premio ($r=\pi^{a}\theta$), la concavidad de la función de costo en este caso no transforma \ref{fo:4} en cóncava. Debido a esto, no se puede encontrar un máximo local que sea también un máximo global en el problema que comprueba la proposición 4.
\vspace{2.5mm}

Esto se comprueba en el gráfico INSERTAR GRÁFICO DE MAXIMIZACIÓN NO CONCAVA
\vspace{2.5mm}

Para lograr la concavidad necesaria, se encuentra la posibilidad de incorporar un elemento del problema original del subastador. Con esto, además de cumplir con la proposición 4, se expande el alcance de este trabajo, ya que ahora no solo se está reordenado el problema al aplicar un sistema nuevo de incentivo, si no que, se incorpora el costo mencionado en el trabajo originial de AMIGO llamado Costo Social del Carbón (SCC). Con esto amplía el estudio para definir este costo respecto al rendimiento del subastador.
\vspace{2.5mm}

La primera aplicación de este costo es la de entender que el costo SCC dependerá de los permisos emitidos, ya que a mayor cantidad de permisos, existirá mayor costos asociados al uso del carbón. Por lo que, inicialmente, se  define el SCC como: $F(\theta)= \alpha\theta + \beta$ ($\alpha$,$\beta$ parámetros). 
\vspace{2.5mm}

Luego, la idea es que este costo transforme \ref{fo:4} a una función cóncava, por lo que se debe cumplir lo siguiente:

\begin{equation}
\begin{array}{rrclcl}
    F(\theta)= \alpha\theta + \beta = kP^2 \label{fo:5}\\
\end{array}
\end{equation}

Donde, si $k>c$ (de \ref{fo:4}), se logra una función objetivo cóncava. Obteniendo, luego de reemplazar la variable de permisos $\theta$ por su valor en función del rendimiento $P$, la siguiente función de costo social a incorporar en el modelo:

\begin{equation}
\begin{array}{rrclcl}
    F(\frac{(P-d)2c}{\pi^a})= \alpha\frac{(P-d)2c}{\pi^a} + \beta = kP^2 \label{fo:5}\\
\end{array}
\end{equation}

De la cuál, se deben encontrar los valores de $\alpha$ y $\beta$ que cumplan con la igualdad.

\section{Reordenar KKT subastador Amigo et alii}

Para implementar el nuevo modelo del subastador, es necesario entender cómo se comporta el modelo al cambiar los valores de las nuevas variables de forma endógena y comparar los resultados de la resolución de modelo con el original. 
\vspace{2.5mm}

Para comenzar, se evaluó el comportamiento del modelo al incluir el nuevo costo de rendimiento explicado en la función objetivo \ref{fo:performance0}. Este será evaluado al modelar el sistema como un MCP al aplicar el teorema de KKT con el nuevo costo y las restricciones nuevas resolviendo el problema en GAMS y mostrando sus resultados. 

Antes de incluir el rendimiento y atención racional con mayor profundidad, se realizó un estudio del problema al incorporar únicamente el rendimiento en la función objetivo \ref{fo:perfornorest11}, sin añadir nuevas restricciones. Esto, con el objetivo de entender el posible efecto que el rendimiento pueda tener en la maximización de beneficios y tener una primera aproximación de los resultados. La realización de esto se puede ver en detalle en el Anexo \ref{anexo:rendimiento}. 
\vspace{2.5mm}

\begin{equation}
\begin{array}{rrclcl}
    \displaystyle \min_{\theta} & -\theta \pi^aP + \tilde{\mathcal{F}}(P)+F(\theta)  \label{fo:perfornorest11}\\
\end{array}
\end{equation}

Primero, se modeló el problema del subastador únicamente con la función objetivo y la naturaleza de la variable $\theta$, sin incorporar otra restricción. Este, junto con el modelo del productor y las condiciones de mercado, fueron resueltas como un único problema MCP. Al observar los valores de las variables $\theta$(permisos de contaminación emitidos por el subastador) y $\pi^a$(valor de venta de cada permiso por parte del subastador) en la tabla \ref{tabla:sinrestr}, se observa que al no existir una restricción que acote los permisos, estos rápidamente se disparan a cantidades muy altas donde, debido al exceso de oferta, sus precios tienden a 0.
\vspace{2.5mm}

Segundo, se modeló la misma función objetivo incorporando la restricción \ref{res:sub1} del modelo original. Con el objetivo de acotar los permisos y observar cómo el rendimiento, sin incorporar una restricción de factibilidad de los costos, afecta el precio de venta de los permisos. De esto, se encontró que el subastador ignora los costos de rendimiento, ya que los valores encontrados para $\theta$ y  $\pi^a$, con el rendimiento sobre 5\%, son iguales a si no se considera un rendimiento. Sobre esto se entendió que falta incorporar alguna restricción de factibilidad para que el subastador considere su efecto en la función objetivo.
\vspace{2.5mm}

Finalmente, al considerar este primer entendimiento, se lleva a cabo una reestructuración del problema del subastador.


\subsubsection{Modelo con restricción de rendimiento}\label{modelo:conrendimiento}

En esta versión del modelo se evalúa la opción de incluir una restricción que involucre de forma directa el rendimiento donde se espera obtener un análisis de como el modelo responde al rendimiento. Para realizar esto, se decide considerar la restricción de factibilidad donde el ingreso de la venta de permisos multiplicada por el rendimiento debe ser mayor al costo de obtener el rendimiento. 
$$\theta \pi^a P  \geq  c(P-d)^2 $$
$$\leftrightarrow \theta \pi^a P - c(P-d)^2 \geq 0 $$

Agregando esta restricción, se obtiene el siguiente modelo: 

\begin{equation}
\begin{array}{rrclcl}
   \displaystyle \min_{\theta} & -\theta \pi^aP + c(P-d)^2+F(\theta) \\\textrm{s.a.} \label{eq:perforconrestrfact}\\
\end{array}
\end{equation}
\begin{equation}
\begin{array}{cl}
    \theta \pi^a P - c(P-d)^2 \geq 0 & (\eta)  \label{perforconrestrfact:r1}
\end{array}
\end{equation}
\begin{equation}
\begin{array}{cl}
    \theta \geq 0 & (\varrho)
\end{array}
\end{equation}

\ref{eq:perforconrestrfact} se convierte en MCP por medio de las condiciones de KKT explicadas anteriormente en este trabajo. 

$$\mathcal{L}(\theta)=-P\theta\pi^a+\mathcal{F}(\theta)+c(P-d)^2 -\eta(\theta \pi^a P - c(P-d)^2)- \varrho\theta $$

Realizando la derivada de primer orden para $\theta$ se obtiene:

\begin{equation}
\begin{array}{rrclcl}
    \frac{\partial\mathcal{L}(\theta)}{\partial (\theta)}=-P\pi^a+\frac{\partial\mathcal{F}(\theta)}{\partial(\theta)}-\eta(\pi^a P) -\varrho=0 \label{lag30}\\
\end{array}
\end{equation}
\begin{equation}
\begin{array}{rrclcl}
    \rightarrow -P\pi^a(1+\eta)+\frac{\partial\mathcal{F}(\theta)}{\partial(\theta)}=\varrho \label{lag31}\\
\end{array}
\end{equation}

Obteniendo la primera complementariedad:

\begin{equation}
\begin{array}{rrclcl}
    0\leq -P\pi^a(1+\eta)+\frac{\partial\mathcal{F}(\theta)}{\partial(\theta)} \perp \theta \geq 0 \label{compllag3}\\
\end{array}
\end{equation}

La segunda complementariedad se obtiene al considera la restricción \ref{perforconrestrfact:r1} con su variable dual respectiva $\eta$. Obteniendo:

\begin{equation}
\begin{array}{rrclcl}
    0 \leq \theta \pi^a P - c(P-d)^2 \perp \eta \geq 0 \label{compllag3}\\
\end{array}
\end{equation}

Finalmente, esta reformulación del modelo como MCP, junto con los MCP de los productores

